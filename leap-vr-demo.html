<html>
	<head>
		<title>Leap VR BIMscript Demo</title>
		<style>
		</style>

    <!--LOAD ALL JAVASCRIPTS-->

    <!--THREE.JS script-->
    <script src="scripts/three.js"></script>
    <!--VR Control scripts-->
    <script src="scripts/VRControls.js"></script>
    <script src="scripts/VREffect.js"></script>
    <!--Leap Motion scripts-->
    <script src="scripts/leap-0.6.4.js"></script>
    <script src="scripts/leap-plugins-0.1.11pre.js"></script>
    <!--<script src="scripts/leap-plugins-0.1.6.js"></script> THIS DOESN'T WORK-->
	</head>

	<body>
    <canvas id="scene"></canvas>
	</body>


<script>
  // Including this in the footer so that the bone hand plugin can create its canvas on the body

  /////////////////////////////////////////////////////////////////////////////////////////////
  // CREATE THE SCENE
  //

    // Set Global Variables
    var scene, camera, canvas, renderer;

    // Set up scene and cameras
    scene = new THREE.Scene();
    camera = new THREE.PerspectiveCamera( 90, window.innerWidth / window.innerHeight, 0.001, 700 );
    camera.position.set (10, 10, 0);
    camera.position.z = 10;
    scene.add(camera);

    // Set up canvas for bone plugin to load
    canvas = document.getElementById('scene');
    canvas.style.position = 'absolute';
    canvas.style.top = 0;
    canvas.style.left = 0;

    // Set up renderer
    renderer = new THREE.WebGLRenderer({ antialias: true, canvas: canvas });
    renderer.setSize(window.innerWidth, window.innerHeight);

    // Set up window resize handler
    onResize = function() {
      camera.aspect = window.innerWidth / window.innerHeight;
      camera.updateProjectionMatrix();
      renderer.setSize(window.innerWidth, window.innerHeight);
    };
    window.addEventListener('resize', onResize, false);

    // Set up lighting
    var light = new THREE.AmbientLight( 0x404040 );
    scene.add(light);

    // Generate axes in scene for reference
    var axis = new THREE.AxisHelper( 250 );
    scene.add( axis );

    // Generate ground plane (box) in scene for reference
    mesh = new THREE.GridHelper( 250, 10 );
    scene.add( mesh );

    // Creating skybox particles to help give people reference points when rotating
    for( var i = 0; i < 10; i++ ){
      var geometry = new THREE.Geometry();

      for( var j = 0; j < 1000; j++ ){
        var x = (Math.random() - .2 ) * 2000;
        var y = (Math.random() - .2 ) * 2000;
        var z = (Math.random() - .2 ) * 2000;
        geometry.vertices.push( new THREE.Vector3( x , y , z ) );
      }

      var color = new THREE.Color( 0xffffff );
      var material = new THREE.ParticleSystemMaterial( { size: 2, color: color });
      var particleSystem = new THREE.ParticleSystem( geometry , material );
      scene.add( particleSystem );
    }

  /////////////////////////////////////////////////////////////////////////////////////////////
  // ADD LEAP MOTION
  //

  // Connect to localhost and start getting frames
  Leap.loop();
  Leap.loopController.use('transform', {
    // This matrix flips the x, y, and z axis, scales to meters, and offsets the hands by -8cm.
    vr: true,
    effectiveParent: camera
  });

  // Pass in the scene and display the arms
  Leap.loopController.use('boneHand', {
    scene: scene,
    arm: true
  });

  /////////////////////////////////////////////////////////////////////////////////////////////
  // ADD VIRTUAL REALITY
  //

  // Moves (translates and rotates) the camera
  var vrControls = new THREE.VRControls(camera, function(message){
    console.log(message);
  });

  var vrEffect = new THREE.VREffect(renderer, function(message){
      console.log(message);
    });

  /////////////////////////////////////////////////////////////////////////////////////////////
  // SET UP FUNCTIONS FOR SHORTCUTS
  //

  var onkey = function(event) {
    if (event.key === 'z' || event.keyCode === 122) {
      vrControls.zeroSensor();
    }

    if (event.key === 'f' || event.keyCode === 102) {
      console.log('f');
      return vrEffect.setFullScreen(true);
    }
  };

  window.addEventListener("keypress", onkey, true);

  /////////////////////////////////////////////////////////////////////////////////////////////
  // BUILD THINGS IN THE SCENE
  //

  // BIMserver JSON loader goes here
  
  // BEGIN Clara.io JSON loader code
  var objectLoader = new THREE.ObjectLoader();
  objectLoader.load("models/teapot-claraio.json", function ( obj ) {
    scene.add( obj );
  } );
  // END Clara.io JSON loader code

  // Create geometry to look at
  var geo = new THREE.BoxGeometry( 40, 40, 40, 20, 20, 20 ); 
  var mat = new THREE.MeshBasicMaterial( { color: 0xe7d300, wireframe: true } ); 
  var cube = new THREE.Mesh( geo , mat );
  scene.add( cube );

  /////////////////////////////////////////////////////////////////////////////////////////////
  // RENDER THE SHITE
  //

  var render = function() {
    vrControls.update();
    vrEffect.render(scene, camera);
    requestAnimationFrame(render);
  };

  render();











  //
  // Add a debug message Real quick
  // Prints out when receiving oculus data.
  //
  //

  var receivingPositionalData = false;
  var receivingOrientationData = false;

  var timerID = setInterval(function(){

    if (camera.position.x !== 0 && !receivingPositionalData){
      receivingPositionalData = true;
      console.log("receiving positional data");
    }

    if (camera.quaternion.x !== 0 && !receivingOrientationData){
      receivingOrientationData = true;
      console.log("receiving orientation data");
    }

    if (receivingOrientationData && receivingPositionalData){
      clearInterval(timerID);
    }

  }, 2000);




</script>
</html>
